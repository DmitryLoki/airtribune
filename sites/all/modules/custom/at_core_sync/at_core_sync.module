<?php

include_once 'at_core_sync.features.inc';

define('AIRTRIBUNE_CORE_ID_FIELD', 'field_core_id');

/**
 * @file
 * Installation file for the Airtribune Core API module.
 */
 
 /**
 * Returns Core ID from entity
 */
function get_id_from_entity($entity) {
  $field_core_id = field_get_items($entity->entityType(), $entity, AIRTRIBUNE_CORE_ID_FIELD);
  if (!empty($field_core_id[0]['value'])) {
    return $field_core_id[0]['value'];
  }
  else {
    return FALSE;
  }
}

/**
 * Returns Core ID from entity
 */
function get_id_from_user($entity) {
  $field_core_id = field_get_items('user', $entity, AIRTRIBUNE_CORE_ID_FIELD);
  if (!empty($field_core_id[0]['value'])) {
    return $field_core_id[0]['value'];
  }
  else {
    return FALSE;
  }
}

/**
 * Returns Core ID from entity
 */
function get_id_from_contest($entity) {
  $field_core_id = field_get_items('node', $entity, AIRTRIBUNE_CORE_ID_FIELD);
  if (!empty($field_core_id[0]['value'])) {
    return $field_core_id[0]['value'];
  }
  else {
    return FALSE;
  }
}

/**
 * Returns Contest Core ID from race entity
 */
function get_contest_id_from_race($entity) {
  $contest_id = $this->entity->og_group_ref['und'][0]['target_id'];
  $contest = node_load($contest_id);
  $field_core_id = field_get_items('node', $contest, AIRTRIBUNE_CORE_ID_FIELD);
  if (!empty($field_core_id[0]['value'])) {
    return $field_core_id[0]['value'];
  }
  else {
    return FALSE;
  }
}

/**
 * Returns Contest Core ID from race entity
 */
function get_race_id_from_race($entity) {
  $field_core_id = field_get_items('ent_race', $entity, AIRTRIBUNE_CORE_ID_FIELD);
  if (!empty($field_core_id[0]['value'])) {
    return $field_core_id[0]['value'];
  }
  else {
    return FALSE;
  }
}

/**
 * Returns synchronization class
 */
function _get_class_by_entity($entity, $type) {
  require_once drupal_get_path("module", "at_core_sync") . "/at_core_sync.class.inc";

  $class = FALSE;
  $tmp = $type;

  if (!empty($entity->type)) {
    $tmp .= ':' . $entity->type;
  }

  $classes = array(
    'node:pg_contest' => 'ATSyncContest',
    'user' => 'ATSyncPerson',
    'og_membership:pg_contestant' => 'ATSyncPilot',
    'ent_race:pg_race' => 'ATSyncRace',
    'ent_tracker:device' => 'ATSyncTracker',
  );

  if (!empty($classes[$tmp])) {
    $class = $classes[$tmp];
    return new $class($entity, $type);
  } else {
    return FALSE;
  }
}

/**
 * Implements hook_entity_update().
 */
function at_core_sync_entity_update($entity, $type) {
  at_core_sync_entity_sync($type, $entity);
  at_core_sync_other_sync($type, $entity);
}

/**
 * Implements hook_entity_insert().
 */
function at_core_sync_entity_insert($entity, $type) {
  at_core_sync_entity_sync($type, $entity);
  at_core_sync_other_sync($type, $entity);
}

/**
 * Implements hook_menu().
 */
function at_core_sync_menu() {
  $items = array();
  $items['admin/config/core_api'] = array(
    'title' => 'Core API',
    'description' => 'Airtribune Core API',
    'file' => 'at_core_sync.admin.inc',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('at_core_sync_admin_settings'),
    'access arguments' => array('administer site configuration'),
  );
  $items['admin/config/core_api/settings'] = array(
    'title' => 'Settings',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
    'access arguments' => array('administer site configuration'),
  );

  $items['admin/config/core_api/fields'] = array(
    'title' => 'Fields',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('at_core_sync_fields_form'),
    'file' => 'at_core_sync.admin.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => -5,
    'access arguments' => array('administer site configuration'),
  );

  return $items;
}
/**
 * Get CoreAPI version.
 * 
 * @author Vyacheslav Malchik <info@vkey.biz>
 * @see #3115.
 */
function at_core_sync_get_api_version() {
  $result = variable_get('at_core_sync_version', 'v0.1');
  return $result;
}

/**
 * Get CoreAPI url.
 * 
 * @author Vyacheslav Malchik <info@vkey.biz>
 * @see #3115.
 */
function at_core_sync_get_api_url() {
  $address = variable_get('at_core_sync_address', 'http://api.airtribune.com')
    . '/'
    .at_core_sync_get_api_version();
  return $address;
}

/**
 * Get all contests from Core.
 */
function get_contests_from_core() {
  return ATSync::requestToCore("contest", FALSE, "GET");
}

/**
 * Get all races from contest from Core.
 */
function get_races_from_contest_core($core_id) {
  return ATSync::requestToCore("contest/" . $core_id . "/race", FALSE, "GET");
}

/**
 * Get all paragliders from contest from Core.
 */
function get_paragliders_from_contest_core($core_id) {
  return ATSync::requestToCore("contest/" . $core_id . "/paraglider", FALSE, "GET");
}

// Debug function
function _d($var) {
  drupal_set_message(print_r($var, TRUE));
}


/**
 * Implements hook_action_info()
 */
function at_core_sync_action_info() {
  return array(
    'at_core_sync_contests_action' => array(
        'type' => 'node',
        'label' => t('[Core API] Sync contests'),
        'configurable' => FALSE,
        'aggregate' => FALSE,
        'hooks' => array (
                'any' => TRUE,
        ),
    ),
    'at_core_sync_contestants_action' => array(
        'type' => 'og_membership',
        'label' => t('[Core API] Sync contestants'),
        'configurable' => FALSE,
        'aggregate' => FALSE,
        'hooks' => array (
                'any' => TRUE,
        ),
    ),
    'at_core_sync_races_action' => array(
        'type' => 'ent_race',
        'label' => t('[Core API] Sync races'),
        'configurable' => FALSE,
        'aggregate' => FALSE,
        'hooks' => array (
                'any' => TRUE,
        ),
    ),
    'at_core_sync_races_tracks_action' => array(
        'type' => 'ent_race',
        'label' => t('[Core API] Send tracks'),
        'configurable' => FALSE,
        'aggregate' => FALSE,
        'hooks' => array (
                'any' => TRUE,
        ),
    ),
  );
}

function at_core_sync_other_sync($entity_type, $entity) {
  if (variable_get('at_core_sync_enabled', 0)) {
    if ($sync = _get_class_by_entity($entity, $entity_type)) {
      //TODO: move custom actions to hooks
      switch($entity_type) {
        case 'ent_race':
          return$sync->pushTracks();
          break;
      }
    }
  }
  return FALSE;
}

function at_core_sync_entity_sync($entity_type, $entity) {

  if (variable_get('at_core_sync_enabled', 0)) {
    if ($sync = _get_class_by_entity($entity, $entity_type)) {
      return $sync->synchronize();
    }
  }
  return FALSE;
}

/**
* Implementation of a Drupal action
*
* @param object $object
* @param array $context
*/
function at_core_sync_contests_action(&$object, $context = array()) {
  at_core_sync_entity_sync('node', $object);
}

/**
* Implementation of a Drupal action
*
* @param object $object
* @param array $context
*/
function at_core_sync_contestants_action(&$object, $context = array()) {
  at_core_sync_entity_sync('og_membership', $object);
}

/**
* Implementation of a Drupal action
*
* @param object $object
* @param array $context
*/
function at_core_sync_races_action(&$object, $context = array()) {
  at_core_sync_entity_sync('ent_race', $object);
}

/**
* Implementation of a Drupal action
*
* @param object $object
* @param array $context
*/
function at_core_sync_races_tracks_action(&$object, $context = array()) {
  at_core_sync_other_sync('ent_race', $object);
}