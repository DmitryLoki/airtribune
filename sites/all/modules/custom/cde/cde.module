<?php

function cde_menu() {
  $items['cde/test/%'] = array(
   'title' => 'CDE Test', 
    'page callback' => 'cde_test',
    'page arguments' => array(2),
    'access callback' => TRUE, 
    //'file' => 'abc.tmp.inc',
  );
  return $items;
}

function cde_test($nid) {
  global $user;
  
  // TODO: Temporary event id
  $nid = 5438;
  
  return $user->uid ? cde_form_authorized($nid) : cde_form_anonymous($nid);
}




function cde_form_anonymous($nid) {
  module_load_include('inc', 'og_ui', 'og_ui.pages');
  module_load_include('inc', 'cde');
  
  global $user;
  
  $settings = array(
    '#subforms' => array(
      array(
        'form_id' => 'user_register_form',
        '#before_execute' => array('cde_user_register_before_execute'),
        '#after_execute' => array('cde_user_register_after_execute'),
      ),
      array(
        'form_id' => 'og_ui_confirm_subscribe',
        'args' => cde_form_args($nid),
      ),
    ),
  );
  return abc_get_form($settings);
}





function cde_form_authorized($nid) {
  return 'test';
}


function cde_form_args($nid) {
  global $user;
  
  $entity_type = 'node';
  $etid = $nid;
  
  $entity = entity_load_single($entity_type, $etid);
  list($id, $vid, $bundle) = entity_extract_ids($entity_type, $entity);
  $field_name = og_get_best_group_audience_field('user', $user->uid, $entity_type, $bundle);
  
  //$entity_type, $id, $user, $field_name
  return array($entity_type, $id, $user, $field_name);
}
